document.addEventListener("DOMContentLoaded", () => {
  // ============================
  // THEME TOGGLE
  // ============================
  const toggle = document.getElementById("theme-toggle");

  // Load saved theme preference
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "dark") {
    document.body.classList.add("dark-mode");
    toggle.textContent = "☀️";
  } else {
    toggle.textContent = "🌙";
  }

  // Toggle theme on click
  toggle.addEventListener("click", () => {
    const isDark = document.body.classList.toggle("dark-mode");
    toggle.textContent = isDark ? "☀️" : "🌙";
    localStorage.setItem("theme", isDark ? "dark" : "light");
  });

  // ============================
  // FIREBASE SETUP
  // ============================
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ============================
  // DOM ELEMENTS
  // ============================
  const form = document.getElementById("poll-form");
  const resultsDiv = document.getElementById("results");
  const resultsDisplay = document.getElementById("results-display");

  // ============================
  // VOTE LIMIT (ONE PER USER)
  // ============================
  const userId =
    localStorage.getItem("voterId") ||
    (() => {
      const id = Math.random().toString(36).substring(2);
      localStorage.setItem("voterId", id);
      return id;
    })();

  const voted = localStorage.getItem("hasVoted");

  if (voted) {
    form.style.display = "none";
    resultsDiv.classList.remove("hidden");
  }

  // ============================
  // HANDLE VOTE SUBMISSION
  // ============================
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const choice = form.vote.value;
    if (!choice) return alert("Please select an option!");

    try {
      // Check if user already voted
      const existingVote = await db
        .collection("votes")
        .where("userId", "==", userId)
        .get();

      if (!existingVote.empty) {
        alert("You’ve already voted!");
        return;
      }

      await db.collection("votes").add({
        userId,
        choice,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      });

      localStorage.setItem("hasVoted", "true");
      form.style.display = "none";
      resultsDiv.classList.remove("hidden");
    } catch (err) {
      console.error("Error saving vote:", err);
      alert("Error saving vote, please try again.");
    }
  });

  // ============================
  // LIVE RESULTS
  // ============================
  db.collection("votes").onSnapshot((snapshot) => {
    const counts = { option1: 0, option2: 0, option3: 0 };
    snapshot.forEach((doc) => {
      const data = doc.data();
      if (counts[data.choice] !== undefined) counts[data.choice]++;
    });

    resultsDisplay.innerHTML = `
      <p><strong>Expand Marketing:</strong> ${counts.option1}</p>
      <p><strong>Increase Burn Rate:</strong> ${counts.option2}</p>
      <p><strong>Focus on AI Integration:</strong> ${counts.option3}</p>
    `;
  });
});
